
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>CAN Communication Protocol &#8212; ODRI Firmware for CAN 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="LED Blink Codes" href="led_codes.html" />
    <link rel="prev" title="Connecting via CAN" href="can_connection.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong>The mw_dual_motor_torque_ctrl repository is not maintained anymore!</strong></p>
<p>The CAN firmware has been integrated into the <a class="reference external" href="https://github.com/open-dynamic-robot-initiative/udriver_firmware">udriver_firmware</a>
repository and will be maintained there from now on.
See the <a class="reference external" href="https://open-dynamic-robot-initiative.github.io/udriver_firmware">documentation of udriver_firmware</a>
for up-to-date installation and usage instructions.</p>
</div>
<section id="can-communication-protocol">
<h1>CAN Communication Protocol<a class="headerlink" href="#can-communication-protocol" title="Permalink to this headline">¶</a></h1>
<p>Each frame has an 11-bit identifier, which is used to distinguish different
types of messages. In the following the protocol (which identifier is used for
which data and how the data is stored inside the frame) that is used by the
firmware is described.</p>
<p>Note that in the CAN protocol, the identifier is also used to define priorities.
If two nodes try to send at the same time, the message with the lower ID comes
first.</p>
<p>The 8 byte of data of a frame are split into a “lower” and a “higher” part of 4
bytes each. Following the names used in the CAN module they are referred to as
MDL and MDH here.</p>
<section id="bit-timing">
<h2>Bit timing<a class="headerlink" href="#bit-timing" title="Permalink to this headline">¶</a></h2>
<p>The firmware is configured for communication at 1 Mbit/s using a sampling point
of 86.7%.</p>
</section>
<section id="messages-sent-from-the-board">
<h2>Messages sent from the board<a class="headerlink" href="#messages-sent-from-the-board" title="Permalink to this headline">¶</a></h2>
<table class="docutils align-default">
<colgroup>
<col style="width: 6%" />
<col style="width: 41%" />
<col style="width: 11%" />
<col style="width: 41%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ID</p></th>
<th class="head"><p>Meaning</p></th>
<th class="head"><p>Size [Bytes]</p></th>
<th class="head"><p>Structure of the data</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x010</p></td>
<td><p>Status</p></td>
<td><p>1</p></td>
<td><p>see <a class="reference internal" href="#status-message">Status Message</a></p></td>
</tr>
<tr class="row-odd"><td><p>0x020</p></td>
<td><p>Current <span class="math notranslate nohighlight">\(I_q\)</span> (both motors)</p></td>
<td><p>8</p></td>
<td><ul class="simple">
<li><p>MDL: <span class="math notranslate nohighlight">\(I_q\)</span> of motor 1</p></li>
<li><p>MDH: <span class="math notranslate nohighlight">\(I_q\)</span> of motor 2</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>0x030</p></td>
<td><p>Encoder Position (both motors)</p></td>
<td><p>8</p></td>
<td><ul class="simple">
<li><p>MDL: Position of motor 1</p></li>
<li><p>MDH: Position of motor 2</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>0x040</p></td>
<td><p>Velocity (both motors)</p></td>
<td><p>8</p></td>
<td><ul class="simple">
<li><p>MDL: Velocity of motor 1</p></li>
<li><p>MDH: Velocity of motor 2</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>0x050</p></td>
<td><p>Additional ADC inputs
(e.g. used for potentiometers or other sensors)</p></td>
<td><p>8</p></td>
<td><ul class="simple">
<li><p>MDL: ADC reading of input A6</p></li>
<li><p>MDH: ADC reading of input B6</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>0x060</p></td>
<td><p>Encoder Index Position</p>
<p><em>This is not sent with a fixed rate but whenever</em>
<em>the encoder index is detected.</em></p>
</td>
<td><p>5</p></td>
<td><ul class="simple">
<li><p>MDL (4 Bytes): Motor position at the index tick</p></li>
<li><p>MDH (1 Byte): ID of the motor</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The motor data (current, position, velocity) is send as Q24 values. Divide
by 2<sup>24</sup> to get the float representation.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The IDs 0x100 and 0x101 are by default used by the OptoForce sensor. To keep
things simple, we should not use these IDs for other data, so we don’t have
to reconfigure the sensors.</p>
</div>
<section id="status-message">
<h3>Status Message<a class="headerlink" href="#status-message" title="Permalink to this headline">¶</a></h3>
<p>The status message contains one byte of data which is structured as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 18%" />
<col style="width: 18%" />
<col style="width: 17%" />
<col style="width: 19%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Bit 5-7</p></th>
<th class="head"><p>Bit 4</p></th>
<th class="head"><p>Bit 3</p></th>
<th class="head"><p>Bit 2</p></th>
<th class="head"><p>Bit 1</p></th>
<th class="head"><p>Bit 0</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Error Code</p></td>
<td><p>Flag motor 2 ready</p></td>
<td><p>Flag motor 2 enabled</p></td>
<td><p>Flag motor 1 ready</p></td>
<td><p>Flag motor 1 enabled</p></td>
<td><p>Flag system enabled</p></td>
</tr>
</tbody>
</table>
<p>A motor is “ready” when the alignment process is finished.</p>
<section id="error-codes">
<h4>Error Codes<a class="headerlink" href="#error-codes" title="Permalink to this headline">¶</a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Error Code</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>No Error</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Encoder Error</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>CAN Receive Timeout</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Critical Motor Temperature (currently unused)</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>Some error in the Position Converter module</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>Position Rollover (position exceeded max value)</p>
<p><em>This error is by default disabled. To enable it, send a ENABLE_POS_ROLLOVER_ERROR=1 command.</em></p>
</td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>Other Error (to be used if we run out of free error codes)</p></td>
</tr>
</tbody>
</table>
<p>Note that the error code for critical motor temperature won’t be used for now,
as we don’t have any temperature sensing. As this might be added in the future,
I already reserve an error code for this, though.  The “Other Error” code is
also not used so far. It may be useful if we run out of error codes at some
point.</p>
</section>
</section>
</section>
<section id="messages-sent-to-the-board">
<h2>Messages sent to the board<a class="headerlink" href="#messages-sent-to-the-board" title="Permalink to this headline">¶</a></h2>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 18%" />
<col style="width: 32%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ID</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Meaning [Unit]</p></th>
<th class="head"><p>Structure of the data</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x000</p></td>
<td><p>CAN_ID_COMMANDS</p></td>
<td><p>Command</p></td>
<td><ul class="simple">
<li><p>MDL: value</p></li>
<li><p>MDH: command code (see <a class="reference internal" href="#command-codes">Command Codes</a>)</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>0x005</p></td>
<td><p>CAN_ID_IqRef</p></td>
<td><p>Current <span class="math notranslate nohighlight">\(I_q\)</span> Reference
<span class="math notranslate nohighlight">\([A]\)</span></p></td>
<td><ul class="simple">
<li><p>MDL: IqRef for motor 1</p></li>
<li><p>MDH: IqRef for motor 2</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>0x006</p></td>
<td><p>CAN_ID_KP</p></td>
<td><p>Gains for P controller
<span class="math notranslate nohighlight">\([\frac{A}{mrev}]\)</span></p></td>
<td><ul class="simple">
<li><p>MDL: P gain for motor 1</p></li>
<li><p>MDH: P gain for motor 2</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>0x007</p></td>
<td><p>CAN_ID_KD</p></td>
<td><p>Gains for D controller
<span class="math notranslate nohighlight">\([\frac{A}{kmrev / min}]\)</span></p></td>
<td><ul class="simple">
<li><p>MDL: D gain for motor 1</p></li>
<li><p>MDH: D gain for motor 2</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>0x008</p></td>
<td><p>CAN_ID_POS_REF</p></td>
<td><p>Reference for P controller
<span class="math notranslate nohighlight">\([mrev]\)</span></p></td>
<td><ul class="simple">
<li><p>MDL: Reference position for motor 1</p></li>
<li><p>MDH: Reference position for motor 2</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>0x009</p></td>
<td><p>CAN_ID_VEL_REF</p></td>
<td><p>Reference for D controller
<span class="math notranslate nohighlight">\([\frac{kmrev}{min}]\)</span></p></td>
<td><ul class="simple">
<li><p>MDL: Reference velocity for motor 1</p></li>
<li><p>MDH: Reference velocity for motor 2</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><span class="math notranslate nohighlight">\(mrev\)</span> = motor revolutions.  E.g. 0.5 is half a revolution, 1.0 a full revolution, 2.0 two revolutions, etc.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Please note that current reference values have to be send as Q24 values.  To
convert float to Q24 multiply by 2<sup>24</sup> and round to an integer.</p>
</div>
<section id="command-codes">
<h3>Command Codes<a class="headerlink" href="#command-codes" title="Permalink to this headline">¶</a></h3>
<p>A command message (ID = 0) consists of two parts. The high bytes (MDH) contain a
code that is associated with a specific parameter (see table below) while the
lower bytes (MDL) contain the value that is to be assigned to the parameter.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 4%" />
<col style="width: 30%" />
<col style="width: 53%" />
<col style="width: 6%" />
<col style="width: 6%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Code</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Meaning [Unit]</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x01</p></td>
<td><p>ENABLE_SYS</p></td>
<td><p>Enable the system.</p></td>
<td><p>0/1</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>0x02</p></td>
<td><p>ENABLE_MTR1</p></td>
<td><p>Enable Motor 1</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>0x03</p></td>
<td><p>ENABLE_MTR2</p></td>
<td><p>Enable Motor 2</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0x04</p></td>
<td><p>ENABLE_VSPRING1</p></td>
<td><p>Enable virtual spring mode for motor 1</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>0x05</p></td>
<td><p>ENABLE_VSPRING2</p></td>
<td><p>Enable virtual spring mode for motor 2</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0x0C</p></td>
<td><p>SEND_CURRENT</p></td>
<td><p>Send motor currents via CAN</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>0x0D</p></td>
<td><p>SEND_POSITION</p></td>
<td><p>Send encoder positions via CAN</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0x0E</p></td>
<td><p>SEND_VELOCITY</p></td>
<td><p>Send motor velocities via CAN</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>0x0F</p></td>
<td><p>SEND_ADC6</p></td>
<td><p>Send ADC inputs A6/B6 via CAN</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0x14</p></td>
<td><p>SEND_ALL</p></td>
<td><p>Disable/Enable all of the configurable CAN messages</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>0x1E</p></td>
<td><p>SET_CAN_RECV_TIMEOUT</p></td>
<td><p>Set CAN Receive Timeout in milliseconds. Set to zero to disable timeout.</p></td>
<td><p>uint32</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0x1F</p></td>
<td><p>ENABLE_POS_ROLLOVER_ERROR</p></td>
<td><p>Enable the position rollover error</p></td>
<td><p>0/1</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>0x28</p></td>
<td><p>CAN_CMD_P_CONTROLLER_LIMIT_IQ_MTR1</p></td>
<td><p>Set the current limit for the P controller of motor 1 [A]</p></td>
<td><p>IQ24</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0x29</p></td>
<td><p>CAN_CMD_P_CONTROLLER_LIMIT_IQ_MTR2</p></td>
<td><p>Set the current limit for the P controller of motor 2 [A]</p></td>
<td><p>IQ24</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>0x2A</p></td>
<td><p>CAN_CMD_D_CONTROLLER_LIMIT_IQ_MTR1</p></td>
<td><p>Set the current limit for the D controller of motor 1 [A]</p></td>
<td><p>IQ24</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>0x2B</p></td>
<td><p>CAN_CMD_D_CONTROLLER_LIMIT_IQ_MTR2</p></td>
<td><p>Set the current limit for the D controller of motor 2 [A]</p></td>
<td><p>IQ24</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
<p>Example: To enable motor 1, set MDH = 2 and MDL = 1.</p>
<p>Nomenclature: When refering to sending commands in this documentation, the
following nomenclature is used: <code class="docutils literal notranslate"><span class="pre">NAME=value</span></code>. Example: <code class="docutils literal notranslate"><span class="pre">ENABLE_SYS=1</span></code> to
enable the system.</p>
</section>
</section>
<section id="can-receive-timeout">
<h2>CAN Receive Timeout<a class="headerlink" href="#can-receive-timeout" title="Permalink to this headline">¶</a></h2>
<p>The embedded software on the board provides a security feature that disables the
motors in case the CAN connection is interrupted or the controller on the PC
exits without properly shutting down the system. This is done by simply checking
the time since the last current <span class="math notranslate nohighlight">\(I_q\)</span> reference was received and raising
an error if it exceeds a specified timeout.</p>
<p>Note that by default, this feature is disabled! If you want to use it, you have
to enable it by specifying a timeout duration greater than zero (see Command
Codes above). There are a few consequences that have to be kept in mind:</p>
<ul class="simple">
<li><p>Before enabling the motors, set the current references to zero, otherwise the
timeout may be trigger immediately when enabled. Note that this is good
practice anyway as it clears potentially dangerous previous reference values.</p></li>
<li><p>Current references have to be sent in a loop, even if the values do not
change.</p></li>
</ul>
<p>The timeout is only checked when motors are enabled and current references are
not zero. This means that, as long as the current reference is zero, it is okay
to enable the timeout during intialization even if current commands are not send
immediately.</p>
<p>When the timeout is triggered, an error is set and the system is disabled. You
can simply reenable it by sending (in this order) enable system command, a
current=0 command and enable motor commands.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">ODRI Firmware for CAN</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="build_instructions.html">Build &amp; Flash</a></li>
<li class="toctree-l1"><a class="reference internal" href="can_connection.html">Connecting via CAN</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CAN Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="led_codes.html">LED Blink Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="motor_alignment.html">Motor Alignment Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="program_structure_and_frequencies.html">Program Structure &amp; Frequencies</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="can_connection.html" title="previous chapter">Connecting via CAN</a></li>
      <li>Next: <a href="led_codes.html" title="next chapter">LED Blink Codes</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Max Planck Gesellschaft.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/can_interface.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>